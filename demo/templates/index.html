<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Re-ID Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #1e40af; /* blue-800 */
            --secondary-color: #3b82f6; /* blue-500 */
            --background-color: #f3f4f6; /* gray-100 */
            --card-background: #ffffff;
            --text-color: #1f2937; /* gray-800 */
            --muted-text-color: #6b7280; /* gray-500 */
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: var(--card-background);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        .btn-secondary {
            background-color: #e5e7eb; /* gray-200 */
            color: var(--text-color);
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* gray-300 */
        }
        .btn-danger {
            background-color: #dc2626; /* red-600 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #ef4444; /* red-500 */
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .upload-zone.drag-over {
            border-color: var(--primary-color);
            background-color: #eff6ff; /* blue-50 */
        }
        .status-bar {
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }
        .status-info { background-color: #eff6ff; color: #1e40af; }
        .status-success { background-color: #f0fdf4; color: #166534; }
        .status-warning { background-color: #fffbeb; color: #b45309; }
        .status-error { background-color: #fef2f2; color: #b91c1c; }
        .video-placeholder {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted-text-color);
            font-size: 1.25rem;
            border-radius: 0.5rem;
        }
        #matchedGallery img {
            width: 100%;
            height: auto;
            object-fit: cover;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease, opacity 0.3s ease;
            background-color: #f3f4f6;
        }
        #matchedGallery img:hover {
            transform: scale(1.05);
        }
        #matchedGallery img[src=""] {
            opacity: 0.5;
            background: linear-gradient(90deg, #f0f0f0 25%, transparent 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .match-item {
            break-inside: avoid;
            margin-bottom: 1rem;
        }
        #matchedGallery {
            column-count: auto;
            column-width: 300px;
            column-gap: 1rem;
        }
        @media (max-width: 768px) {
            #matchedGallery {
                column-count: 1;
            }
        }
        .notification {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 50;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        .notification-success { background-color: #22c55e; }
        .notification-error { background-color: #ef4444; }

        /* Modal styles */
        #imageModal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.8);
        }
        #imageModal .modal-content {
            position: relative;
            margin: auto;
            padding: 0;
            max-width: 90%;
            max-height: 90%;
        }
        #imageModal img {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
        #imageModal .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }
    </style>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="min-h-screen">

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <h1 class="text-3xl font-bold text-gray-900">Vehicle Re-Identification Dashboard</h1>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Controls & Status -->
            <div class="lg:col-span-1 space-y-6">
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Controls</h2>
                    <div class="space-y-4">
                        <button id="startBtn" class="btn btn-primary w-full" disabled>Start Processing</button>
                        <button id="stopBtn" class="btn btn-danger w-full" disabled>Stop Processing</button>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold mb-2">Session Status</h2>
                    <div id="statusBar" class="status-bar status-info">Initializing...</div>
                    <div class="mt-4 text-sm text-gray-600">
                        <strong>Session ID:</strong> <span id="sessionId">N/A</span>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Camera 1 Upload</h2>
                    <div id="uploadZone1" class="upload-zone">
                        <p>Drag & drop video or click to select</p>
                        <input type="file" id="videoFile1" class="hidden" accept="video/*">
                    </div>
                    <div id="uploadStatus1" class="mt-2 text-sm"></div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Camera 2 Upload</h2>
                    <div id="uploadZone2" class="upload-zone">
                        <p>Drag & drop video or click to select</p>
                        <input type="file" id="videoFile2" class="hidden" accept="video/*">
                    </div>
                    <div id="uploadStatus2" class="mt-2 text-sm"></div>
                </div>
            </div>

            <!-- Right Column: Video Feeds & Matches -->
            <div class="lg:col-span-2 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h3 class="text-lg font-bold mb-2">Camera 1 Feed</h3>
                        <img id="cam1Feed" class="video-placeholder" src="" alt="Camera 1 Feed">
                        <div class="text-sm text-gray-500 mt-2">Frame Count: <span id="cam1FrameCount">0</span></div>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-bold mb-2">Camera 2 Feed</h3>
                        <img id="cam2Feed" class="video-placeholder" src="" alt="Camera 2 Feed">
                        <div class="text-sm text-gray-500 mt-2">Frame Count: <span id="cam2FrameCount">0</span></div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Matched Vehicles</h2>
                    <div id="matchedGallery" class="masonry-grid">
                        <p id="noMatchesText" class="text-gray-500 w-full">No matches found yet.</p>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Debug Log</h2>
                    <div id="debugLog" class="h-40 bg-gray-800 text-white font-mono text-xs p-2 rounded overflow-y-auto"></div>
                    <button id="clearLogBtn" class="btn btn-secondary mt-2 text-sm py-1 px-2">Clear Log</button>
                </div>
            </div>
        </div>
    </main>

    <div id="notification" class="notification"></div>

    <!-- Modal for full-size image -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="relative max-w-4xl max-h-4xl p-4">
            <button id="closeModal" class="absolute top-2 right-2 text-white text-2xl font-bold z-10 bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-75">
                ×
            </button>
            <img id="modalImage" class="max-w-full max-h-full object-contain rounded" src="" alt="">
            <div id="modalTitle" class="text-white text-center mt-2 font-medium"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = `${window.location.protocol}//${window.location.host}`;
            
            // --- STATE ---
            let sessionId = null;
            let websocket = null;
            let uploads = { cam1: false, cam2: false };
            let processing = false;

            // --- UI ELEMENTS ---
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const statusBar = document.getElementById('statusBar');
            const sessionIdEl = document.getElementById('sessionId');
            const cam1Feed = document.getElementById('cam1Feed');
            const cam2Feed = document.getElementById('cam2Feed');
            const cam1FrameCount = document.getElementById('cam1FrameCount');
            const cam2FrameCount = document.getElementById('cam2FrameCount');
            const matchedGallery = document.getElementById('matchedGallery');
            const noMatchesText = document.getElementById('noMatchesText');
            const debugLog = document.getElementById('debugLog');
            const clearLogBtn = document.getElementById('clearLogBtn');

            // --- NOTIFICATION ---
            const notification = document.getElementById('notification');
            function showNotification(message, type = 'success') {
                notification.textContent = message;
                notification.className = `notification show notification-${type}`;
                setTimeout(() => {
                    notification.className = 'notification';
                }, 3000);
            }

            // --- LOGGING ---
            function logMessage(message) {
                const time = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.textContent = `[${time}] ${message}`;
                debugLog.appendChild(logEntry);
                debugLog.scrollTop = debugLog.scrollHeight;
            }
            clearLogBtn.addEventListener('click', () => debugLog.innerHTML = '');

            // --- UI UPDATE ---
            function updateStatus(text, type = 'info') {
                statusBar.textContent = text;
                statusBar.className = `status-bar status-${type}`;
            }

            function updateButtons() {
                startBtn.disabled = !(uploads.cam1 && uploads.cam2) || processing;
                stopBtn.disabled = !processing;
            }

            // --- WEBSOCKET ---
            function connectWebSocket() {
                if (!sessionId) return;
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws/${sessionId}`;
                
                websocket = new WebSocket(wsUrl);

                websocket.onopen = () => {
                    logMessage('WebSocket connection established.');
                    updateStatus('Ready to process', 'success');
                };

                websocket.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    logMessage(`WS IN: ${JSON.stringify(msg).substring(0, 100)}...`);

                    if (msg.type === 'frame') {
                        const feed = msg.camera === 'cam1' ? cam1Feed : cam2Feed;
                        const countEl = msg.camera === 'cam1' ? cam1FrameCount : cam2FrameCount;
                        
                        feed.src = `data:image/jpeg;base64,${msg.data}`;
                        if (feed.classList.contains('video-placeholder')) {
                            feed.classList.remove('video-placeholder');
                        }
                        countEl.textContent = msg.frame_count;
                    } else if (msg.type === 'match') {
                        // This is now handled by fetchLatestMatches
                        logMessage(`Match notification received (but handled by polling): ${msg.filename}`);
                    }
                };

                websocket.onclose = () => {
                    logMessage('WebSocket connection closed.');
                    if (processing) {
                        updateStatus('Connection lost. Please refresh.', 'error');
                    }
                };

                websocket.onerror = (error) => {
                    logMessage(`WebSocket error: ${error.message}`);
                    showNotification('WebSocket connection error.', 'error');
                };
            }

            // --- API CALLS ---
            async function fetchLatestMatches() {
                if (!processing) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/latest_matches`);
                    if (!response.ok) {
                        logMessage(`Error fetching matches: ${response.status}`);
                        return;
                    }
                    const data = await response.json();
                    
                    if (data.matches && data.matches.length > 0) {
                        if (noMatchesText) noMatchesText.style.display = 'none';
                        
                        // Clear existing matches to prevent duplicates and show only the latest set
                        matchedGallery.innerHTML = '';

                        data.matches.forEach(match => {
                            const matchContainer = document.createElement('div');
                            matchContainer.className = 'match-item border p-3 rounded-lg bg-white shadow-sm';
                            
                            const title = document.createElement('p');
                            title.className = 'font-bold text-sm mb-2 text-gray-800';
                            title.textContent = `Match: ${match.filename}`;
                            matchContainer.appendChild(title);

                            const img = document.createElement('img');
                            // Use the thumbnail URL for better performance
                            const baseUrl = match.thumbnail_url || match.path;
                            const separator = baseUrl.includes('?') ? '&' : '?';
                            img.src = `${API_BASE_URL}${baseUrl}${separator}t=${new Date().getTime()}`;
                            img.alt = match.filename;
                            img.title = `File: ${match.filename}\nTime: ${match.timestamp}`;
                            img.className = 'w-full h-auto rounded cursor-pointer transition-transform hover:scale-105';
                            img.style.maxWidth = '100%';
                            img.style.height = 'auto';
                            img.style.objectFit = 'contain';
                            
                            // Add click handler to show full-size image
                            img.addEventListener('click', () => {
                                showFullSizeImage(match.path, match.filename);
                            });
                            
                            matchContainer.appendChild(img);
                            
                            // Add timestamp
                            const timeDiv = document.createElement('div');
                            timeDiv.className = 'text-xs text-gray-500 mt-2';
                            timeDiv.textContent = new Date(match.timestamp).toLocaleString();
                            matchContainer.appendChild(timeDiv);
                            
                            matchedGallery.appendChild(matchContainer);
                        });
                    }
                } catch (error) {
                    console.error('Error fetching latest matches:', error);
                    logMessage('Could not fetch latest matches.');
                }
            }

            // Function to show full-size image in modal
            function showFullSizeImage(imagePath, filename) {
                // Create modal if it doesn't exist
                let modal = document.getElementById('imageModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'imageModal';
                    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden';
                    modal.innerHTML = `
                        <div class="relative max-w-4xl max-h-4xl p-4">
                            <button id="closeModal" class="absolute top-2 right-2 text-white text-2xl font-bold z-10 bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-75">
                                ×
                            </button>
                            <img id="modalImage" class="max-w-full max-h-full object-contain rounded" src="" alt="">
                            <div id="modalTitle" class="text-white text-center mt-2 font-medium"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // Add close handlers
                    document.getElementById('closeModal').addEventListener('click', () => {
                        modal.classList.add('hidden');
                    });
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.add('hidden');
                        }
                    });
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            modal.classList.add('hidden');
                        }
                    });
                }
                
                // Set image and show modal
                const modalImage = document.getElementById('modalImage');
                const modalTitle = document.getElementById('modalTitle');
                const separator = imagePath.includes('?') ? '&' : '?';
                modalImage.src = `${API_BASE_URL}${imagePath}${separator}t=${new Date().getTime()}`;
                modalTitle.textContent = filename;
                modal.classList.remove('hidden');
            }

            async function startSession() {
                try {
                    updateStatus('Initializing session...');
                    const response = await fetch(`${API_BASE_URL}/start_session`, { method: 'POST' });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    
                    sessionId = data.session_id;
                    sessionIdEl.textContent = sessionId;
                    logMessage(`Session started: ${sessionId}`);
                    
                    connectWebSocket();
                    updateButtons();
                    // Start polling for matches once processing starts
                    setInterval(fetchLatestMatches, 5000); // Poll every 5 seconds
                } catch (error) {
                    console.error('Failed to start session:', error);
                    updateStatus('Failed to start session. Please refresh.', 'error');
                    showNotification('Error starting session.', 'error');
                }
            }

            async function uploadFile(camera, file) {
                if (!sessionId) {
                    showNotification('Session not ready.', 'error');
                    return;
                }
                const uploadStatusEl = document.getElementById(`uploadStatus${camera === 'cam1' ? 1 : 2}`);
                uploadStatusEl.textContent = `Uploading ${file.name}...`;
                
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${API_BASE_URL}/upload_video/${sessionId}?camera=${camera}`, {
                        method: 'POST',
                        body: formData,
                    });
                    if (!response.ok) throw new Error(`Upload failed with status: ${response.status}`);
                    
                    const result = await response.json();
                    uploadStatusEl.innerHTML = `✅ ${file.name} uploaded.`;
                    logMessage(`Uploaded ${file.name} to ${camera}.`);
                    showNotification(`${file.name} uploaded successfully.`, 'success');
                    
                    uploads[camera] = true;
                    updateButtons();
                } catch (error) {
                    console.error(`Upload error for ${camera}:`, error);
                    uploadStatusEl.textContent = `❌ Upload failed. Please try again.`;
                    showNotification(`Error uploading ${file.name}.`, 'error');
                }
            }

            // --- EVENT HANDLERS ---
            startBtn.addEventListener('click', async () => {
                if (!sessionId) return;
                processing = true;
                updateStatus('Starting processing...', 'info');
                updateButtons();
                logMessage('Start processing command sent.');

                try {
                    const response = await fetch(`${API_BASE_URL}/start_processing/${sessionId}`, { method: 'POST' });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    updateStatus('Processing started.', 'success');
                    logMessage('Processing successfully started.');
                    showNotification('Processing started!', 'success');
                } catch (error) {
                    console.error('Failed to start processing:', error);
                    updateStatus('Error starting processing.', 'error');
                    showNotification('Failed to start processing.', 'error');
                    processing = false;
                    updateButtons();
                }
            });

            stopBtn.addEventListener('click', async () => {
                if (!sessionId) return;
                updateStatus('Stopping processing...', 'warning');
                logMessage('Stop processing command sent.');

                try {
                    const response = await fetch(`${API_BASE_URL}/stop_processing/${sessionId}`, { method: 'POST' });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    
                    updateStatus('Processing stopped. Ready for new session.', 'info');
                    logMessage('Processing stopped.');
                    showNotification('Processing stopped.', 'success');
                    
                    processing = false;
                    if (websocket) websocket.close();
                    
                    // Reset for a new session
                    setTimeout(() => window.location.reload(), 2000);

                } catch (error) {
                    console.error('Failed to stop processing:', error);
                    updateStatus('Error stopping processing.', 'error');
                    showNotification('Failed to stop processing.', 'error');
                }
            });

            // --- UPLOAD ZONE SETUP ---
            function setupUploadZone(zoneId, inputId, cameraName) {
                const zone = document.getElementById(zoneId);
                const input = document.getElementById(inputId);

                zone.addEventListener('click', () => input.click());
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });
                zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    const file = e.dataTransfer.files[0];
                    if (file) {
                        uploadFile(cameraName, file);
                    }
                });
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        uploadFile(cameraName, file);
                    }
                });
            }

            setupUploadZone('uploadZone1', 'videoFile1', 'cam1');
            setupUploadZone('uploadZone2', 'videoFile2', 'cam2');

            // --- INITIALIZATION ---
            startSession();
        });
    </script>
</body>
</html>
