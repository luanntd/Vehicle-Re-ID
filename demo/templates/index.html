<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Re-ID Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #1e40af; /* blue-800 */
            --secondary-color: #3b82f6; /* blue-500 */
            --background-color: #f3f4f6; /* gray-100 */
            --card-background: #ffffff;
            --text-color: #1f2937; /* gray-800 */
            --muted-text-color: #6b7280; /* gray-500 */
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: var(--card-background);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        .btn-secondary {
            background-color: #e5e7eb; /* gray-200 */
            color: var(--text-color);
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* gray-300 */
        }
        .btn-danger {
            background-color: #dc2626; /* red-600 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #ef4444; /* red-500 */
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .upload-zone.drag-over {
            border-color: var(--primary-color);
            background-color: #eff6ff; /* blue-50 */
        }
        .status-bar {
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }
        .status-info { background-color: #eff6ff; color: #1e40af; }
        .status-success { background-color: #f0fdf4; color: #166534; }
        .status-warning { background-color: #fffbeb; color: #b45309; }
        .status-error { background-color: #fef2f2; color: #b91c1c; }
        .video-placeholder {
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted-text-color);
            font-size: 1.25rem;
            border-radius: 0.5rem;
        }
        .matched-vehicle-img {
            width: 100%;
            max-width: 100px;
            height: 70px;
            object-fit: cover;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
            transition: transform 0.2s ease, opacity 0.3s ease;
            background-color: #f3f4f6;
        }
        .matched-vehicle-img:hover {
            transform: scale(1.05);
        }
        .matched-vehicle-img[src=""] {
            opacity: 0.5;
            background: linear-gradient(90deg, #f0f0f0 25%, transparent 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        #matchedPairsContainer {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 600px;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .notification {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 50;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        .notification-success { background-color: #22c55e; }
        .notification-error { background-color: #ef4444; }

        /* Modal styles */
        #imageModal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.8);
        }
        #imageModal .modal-content {
            position: relative;
            margin: auto;
            padding: 0;
            max-width: 90%;
            max-height: 90%;
        }
        #imageModal img {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
        #imageModal .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }
    </style>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="min-h-screen">

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <h1 class="text-3xl font-bold text-gray-900">Vehicle Re-Identification Dashboard</h1>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Left Side: Main Content -->
            <div class="lg:w-3/4 space-y-8">
                <!-- Camera feeds section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <!-- Camera 1 Feed -->
                    <div class="card">
                        <h3 class="text-lg font-bold mb-2">Camera 1 Feed</h3>
                        <div class="border-2 border-gray-300 rounded-lg overflow-hidden">
                            <img id="cam1Feed" class="w-full aspect-video object-cover" src="" alt="Camera 1 Feed">
                        </div>
                        <div class="text-sm text-gray-500 mt-2">Frame Count: <span id="cam1FrameCount">0</span></div>
                    </div>

                    <!-- Camera 2 Feed -->
                    <div class="card">
                        <h3 class="text-lg font-bold mb-2">Camera 2 Feed</h3>
                        <div class="border-2 border-gray-300 rounded-lg overflow-hidden">
                            <img id="cam2Feed" class="w-full aspect-video object-cover" src="" alt="Camera 2 Feed">
                        </div>
                        <div class="text-sm text-gray-500 mt-2">Frame Count: <span id="cam2FrameCount">0</span></div>
                    </div>
                </div>

                <!-- Upload zones section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <!-- Camera 1 Upload -->
                    <div class="card">
                        <h2 class="text-lg font-bold mb-4">Upload for Camera 1</h2>
                        <div id="uploadZone1" class="upload-zone">
                            <p>Drag & drop video or click to select</p>
                            <input type="file" id="videoFile1" class="hidden" accept="video/*">
                        </div>
                        <div id="uploadStatus1" class="mt-2 text-sm"></div>
                    </div>

                    <!-- Camera 2 Upload -->
                    <div class="card">
                        <h2 class="text-lg font-bold mb-4">Upload for Camera 2</h2>
                        <div id="uploadZone2" class="upload-zone">
                            <p>Drag & drop video or click to select</p>
                            <input type="file" id="videoFile2" class="hidden" accept="video/*">
                        </div>
                        <div id="uploadStatus2" class="mt-2 text-sm"></div>
                    </div>
                </div>

                <!-- Session & Debug section -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Session Status & Controls -->
                    <div class="md:col-span-1">
                        <div class="card mb-4">
                            <h2 class="text-lg font-bold mb-2">Session Status & Info</h2>
                            <div id="statusBar" class="status-bar status-info mb-2">Initializing...</div>
                            <div class="text-sm text-gray-600">
                                <strong>Session ID:</strong> <span id="sessionId">N/A</span>
                            </div>
                        </div>

                        <div class="card">
                            <button id="startBtn" class="btn btn-primary w-full mb-4" disabled>Start Processing</button>
                            <button id="stopBtn" class="btn btn-danger w-full" disabled>Stop Processing</button>
                        </div>
                    </div>
                    
                    <!-- Debug Log -->
                    <div class="md:col-span-3">
                        <div class="card h-full">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold">Debug Log</h2>
                                <button id="clearLogBtn" class="btn btn-secondary text-sm py-1 px-2">Clear Log</button>
                            </div>
                            <div id="debugLog" class="h-48 bg-gray-800 text-white font-mono text-xs p-3 rounded overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Side: Matched Vehicles -->
            <div class="lg:w-1/4 flex-shrink-0">
                <div class="card h-full">
                    <h2 class="text-xl font-bold mb-4">Matched Vehicles</h2>
                    
                    <!-- Matched vehicle pairs will be displayed here -->
                    <div id="matchedPairsContainer" class="flex flex-col gap-4">
                        <p id="noMatchesPairsText" class="text-gray-500 text-center">No matches found yet.</p>
                        <!-- Matched pairs will be added here dynamically -->
                    </div>
                    
                    <div class="mt-6 text-center text-sm text-gray-500">
                        <span>↓ Direction when new matches appear ↓</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white py-4 border-t mt-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <p class="text-center text-gray-500 text-sm">
                Vehicle Re-ID Demo © 2025 | Built with FastAPI, Kafka, and Spark Streaming
            </p>
        </div>
    </footer>

    <div id="notification" class="notification"></div>

    <!-- Modal for full-size image -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="relative max-w-4xl max-h-4xl p-4">
            <button id="closeModal" class="absolute top-2 right-2 text-white text-2xl font-bold z-10 bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-75">
                ×
            </button>
            <img id="modalImage" class="max-w-full max-h-full object-contain rounded" src="" alt="">
            <div id="modalTitle" class="text-white text-center mt-2 font-medium"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = `${window.location.protocol}//${window.location.host}`;
            
            // --- STATE ---
            let sessionId = null;
            let websocket = null;
            let uploads = { cam1: false, cam2: false };
            let processing = false;

            // --- UI ELEMENTS ---
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const statusBar = document.getElementById('statusBar');
            const sessionIdEl = document.getElementById('sessionId');
            const cam1Feed = document.getElementById('cam1Feed');
            const cam2Feed = document.getElementById('cam2Feed');
            const cam1FrameCount = document.getElementById('cam1FrameCount');
            const cam2FrameCount = document.getElementById('cam2FrameCount');
            const matchedPairsContainer = document.getElementById('matchedPairsContainer');
            const noMatchesPairsText = document.getElementById('noMatchesPairsText');
            const debugLog = document.getElementById('debugLog');
            const clearLogBtn = document.getElementById('clearLogBtn');

            // --- NOTIFICATION ---
            const notification = document.getElementById('notification');
            function showNotification(message, type = 'success') {
                notification.textContent = message;
                notification.className = `notification show notification-${type}`;
                setTimeout(() => {
                    notification.className = 'notification';
                }, 3000);
            }

            // --- LOGGING ---
            function logMessage(message) {
                const time = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.textContent = `[${time}] ${message}`;
                debugLog.appendChild(logEntry);
                debugLog.scrollTop = debugLog.scrollHeight;
            }
            clearLogBtn.addEventListener('click', () => debugLog.innerHTML = '');

            // --- UI UPDATE ---
            function updateStatus(text, type = 'info') {
                statusBar.textContent = text;
                statusBar.className = `status-bar status-${type}`;
            }

            function updateButtons() {
                startBtn.disabled = !(uploads.cam1 && uploads.cam2) || processing;
                stopBtn.disabled = !processing;
            }

            // --- WEBSOCKET ---
            function connectWebSocket() {
                if (!sessionId) return;
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws/${sessionId}`;
                
                websocket = new WebSocket(wsUrl);

                websocket.onopen = () => {
                    logMessage('WebSocket connection established.');
                    updateStatus('Ready to process', 'success');
                };

                websocket.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    
                    // Only log non-frame messages or every 50th frame to avoid console flooding
                    if (msg.type !== 'frame' || (msg.frame_count % 50 === 0)) {
                        logMessage(`WS IN: ${msg.type === 'frame' ? `Frame from ${msg.camera} #${msg.frame_count}` : JSON.stringify(msg).substring(0, 100) + '...'}`);
                    }

                    if (msg.type === 'frame') {
                        const feed = msg.camera === 'cam1' ? cam1Feed : cam2Feed;
                        const countEl = msg.camera === 'cam1' ? cam1FrameCount : cam2FrameCount;
                        
                        feed.src = `data:image/jpeg;base64,${msg.data}`;
                        feed.classList.remove('video-placeholder');
                        countEl.textContent = msg.frame_count;
                    } else if (msg.type === 'match') {
                        // Update matches immediately on match notification, don't wait for the poll
                        logMessage(`Match notification received: ${msg.filename}`);
                        fetchLatestMatches();
                    } else if (msg.type === 'heartbeat') {
                        // Handle heartbeat silently
                        console.log('Heartbeat received', msg.timestamp);
                    }
                };

                websocket.onclose = () => {
                    logMessage('WebSocket connection closed.');
                    if (processing) {
                        updateStatus('Connection lost. Please refresh.', 'error');
                    }
                };

                websocket.onerror = (error) => {
                    logMessage(`WebSocket error: ${error.message}`);
                    showNotification('WebSocket connection error.', 'error');
                };
            }

            // --- API CALLS ---
            async function fetchLatestMatches() {
                // Always fetch matches even if not processing, to show test images
                // if (!processing) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/latest_matches`);
                    if (!response.ok) {
                        logMessage(`Error fetching matches: ${response.status}`);
                        return;
                    }
                    const data = await response.json();
                    
                    if (data.matches && data.matches.length > 0) {
                        logMessage(`Found ${data.matches.length} matches from server`);
                        console.log("Matches data:", data.matches);
                        
                        // Group matches by camera
                        const cam1Matches = data.matches.filter(match => match.filename.includes('cam1'));
                        const cam2Matches = data.matches.filter(match => match.filename.includes('cam2'));
                        
                        logMessage(`Camera 1 matches: ${cam1Matches.length}, Camera 2 matches: ${cam2Matches.length}`);
                        
                        // For test images, if no cam1/cam2 prefixes found, assign them manually
                        if (cam1Matches.length === 0 && cam2Matches.length === 0 && data.matches.length > 0) {
                            logMessage("No camera prefixes found in filenames, assigning manually");
                            // Assign first image to cam1, second to cam2
                            if (data.matches.length >= 1) {
                                const match1 = {...data.matches[0]};
                                match1.filename = `cam1_${match1.filename}`;
                                cam1Matches.push(match1);
                            }
                            if (data.matches.length >= 2) {
                                const match2 = {...data.matches[1]};
                                match2.filename = `cam2_${match2.filename}`;
                                cam2Matches.push(match2);
                            }
                            logMessage(`Assigned manually - Camera 1: ${cam1Matches.length}, Camera 2: ${cam2Matches.length}`);
                        }
                        
                        // Extract vehicle IDs from filenames and pair the matches
                        const vehiclePairs = createVehiclePairs(cam1Matches, cam2Matches);
                        
                        // Update the UI with the matched pairs
                        updateMatchedPairsDisplay(vehiclePairs);
                    }
                } catch (error) {
                    console.error('Error fetching latest matches:', error);
                    logMessage('Could not fetch latest matches.');
                }
            }
            
            // Function to create vehicle pairs from camera matches
            function createVehiclePairs(cam1Matches, cam2Matches) {
                // Map to store pairs by vehicle ID
                const vehiclePairs = new Map();
                
                // Helper function to extract vehicle ID from filename
                const getVehicleId = (filename) => {
                    // Try to extract vehicle ID from filename
                    // This regex pattern looks for "vehicle_123" or similar patterns
                    const match = filename.match(/vehicle[_-](\d+)|track[_-](\d+)/i);
                    if (match) {
                        return match[1] || match[2];
                    }
                    
                    // For test images that don't have a standard vehicle ID format
                    // Just use the first part of the filename as the ID
                    const testImageMatch = filename.match(/cam\d+_(.+)\.jpg$/i);
                    if (testImageMatch) {
                        // Return first 8 chars of filename to use as ID
                        return testImageMatch[1].substring(0, 8);
                    }
                    
                    // If no ID can be extracted, use a part of the filename
                    return filename.replace(/\.[^/.]+$/, "").substring(0, 8); // Remove extension and limit length
                };
                
                // Process camera 1 matches
                cam1Matches.forEach(match => {
                    const id = getVehicleId(match.filename);
                    if (id) {
                        if (!vehiclePairs.has(id)) {
                            vehiclePairs.set(id, { cam1: match, cam2: null });
                        } else {
                            vehiclePairs.get(id).cam1 = match;
                        }
                    }
                });
                
                // Process camera 2 matches and pair with camera 1 matches
                cam2Matches.forEach(match => {
                    const id = getVehicleId(match.filename);
                    if (id) {
                        if (!vehiclePairs.has(id)) {
                            vehiclePairs.set(id, { cam1: null, cam2: match });
                        } else {
                            vehiclePairs.get(id).cam2 = match;
                        }
                    }
                });
                
                return vehiclePairs;
            }
            
            // Function to update the UI with matched vehicle pairs
            function updateMatchedPairsDisplay(vehiclePairs) {
                if (!matchedPairsContainer) return;
                
                // Add debug logging
                logMessage(`Updating display with ${vehiclePairs.size} vehicle pairs`);
                
                // If there are no pairs, show the "no matches" message
                if (vehiclePairs.size === 0) {
                    noMatchesPairsText.style.display = 'block';
                    matchedPairsContainer.innerHTML = '';
                    return;
                }
                
                // Hide the "no matches" message and prepare to display pairs
                noMatchesPairsText.style.display = 'none';
                matchedPairsContainer.innerHTML = '';
                
                // Force processing to true to ensure images are visible for test images
                processing = true;
                
                // Convert the map to an array and sort by ID for consistent display
                const sortedPairs = Array.from(vehiclePairs.entries())
                    .sort((a, b) => {
                        // For test images, which might have string IDs, use string comparison
                        if (isNaN(parseInt(a[0])) || isNaN(parseInt(b[0]))) {
                            return a[0].localeCompare(b[0]);
                        }
                        // Sort by ID numerically for standard vehicle IDs
                        return parseInt(a[0]) - parseInt(b[0]);
                    });
                
                // Create a row for each vehicle pair
                sortedPairs.forEach(([vehicleId, pair]) => {
                    const pairElement = createMatchPairElement(vehicleId, pair);
                    matchedPairsContainer.appendChild(pairElement);
                });
            }
            
            // Helper function to create a match pair element
            function createMatchPairElement(vehicleId, pair) {
                // Create container for the pair
                const pairContainer = document.createElement('div');
                pairContainer.className = 'bg-gray-50 p-3 rounded-lg mb-3';
                
                // Create header with vehicle ID
                const headerDiv = document.createElement('div');
                headerDiv.className = 'font-semibold text-sm mb-2 text-center';
                headerDiv.textContent = `Vehicle ID: ${vehicleId}`;
                pairContainer.appendChild(headerDiv);
                
                // Create flex container for the two images
                const imagesContainer = document.createElement('div');
                imagesContainer.className = 'flex justify-between items-center gap-2';
                
                // Camera 1 image
                const cam1Container = document.createElement('div');
                cam1Container.className = 'flex-1 flex flex-col items-center';
                
                const cam1Label = document.createElement('div');
                cam1Label.className = 'text-xs font-medium mb-1';
                cam1Label.textContent = 'Camera 1';
                cam1Container.appendChild(cam1Label);
                
                if (pair.cam1) {
                    const img1 = document.createElement('img');
                    const baseUrl = pair.cam1.small_thumbnail_url || pair.cam1.thumbnail_url || pair.cam1.path;
                    const separator = baseUrl.includes('?') ? '&' : '?';
                    
                    // Log the image URL for debugging
                    console.log(`Camera 1 image URL: ${API_BASE_URL}${baseUrl}${separator}t=${new Date().getTime()}`);
                    logMessage(`Loading Camera 1 image: ${pair.cam1.filename}`);
                    
                    img1.src = `${API_BASE_URL}${baseUrl}${separator}t=${new Date().getTime()}`;
                    img1.alt = 'Vehicle from Camera 1';
                    img1.className = 'matched-vehicle-img cursor-pointer';
                    img1.title = `${pair.cam1.filename}\n${new Date(pair.cam1.timestamp).toLocaleTimeString()}`;
                    
                    // Add error handler for image loading
                    img1.onerror = (e) => {
                        console.error(`Failed to load image: ${img1.src}`, e);
                        logMessage(`Failed to load Camera 1 image: ${pair.cam1.filename}`);
                        // Replace with placeholder
                        img1.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f0f0f0'/%3E%3Ctext x='50' y='50' font-family='Arial' font-size='12' text-anchor='middle' dominant-baseline='middle' fill='%23999'%3EImage Error%3C/text%3E%3C/svg%3E";
                    };
                    
                    // Add load handler
                    img1.onload = () => {
                        logMessage(`Camera 1 image loaded: ${pair.cam1.filename}`);
                    };
                    
                    img1.addEventListener('click', () => {
                        showFullSizeImage(pair.cam1.path, pair.cam1.filename);
                    });
                    
                    cam1Container.appendChild(img1);
                    
                    // Show timestamp if available
                    if (pair.cam1.timestamp) {
                        const time = document.createElement('div');
                        time.className = 'text-xs text-gray-500 mt-1';
                        time.textContent = new Date(pair.cam1.timestamp).toLocaleTimeString();
                        cam1Container.appendChild(time);
                    }
                } else {
                    // Placeholder if no image for camera 1
                    const placeholder = document.createElement('div');
                    placeholder.className = 'matched-vehicle-img flex items-center justify-center bg-gray-200 text-gray-400 text-xs';
                    placeholder.textContent = 'No match';
                    cam1Container.appendChild(placeholder);
                }
                
                // Arrow between images
                const arrowContainer = document.createElement('div');
                arrowContainer.className = 'flex-shrink-0 px-2';
                const arrow = document.createElement('div');
                arrow.className = 'text-gray-400 font-bold';
                arrow.innerHTML = '⟷'; // Bidirectional arrow
                arrowContainer.appendChild(arrow);
                
                // Camera 2 image
                const cam2Container = document.createElement('div');
                cam2Container.className = 'flex-1 flex flex-col items-center';
                
                const cam2Label = document.createElement('div');
                cam2Label.className = 'text-xs font-medium mb-1';
                cam2Label.textContent = 'Camera 2';
                cam2Container.appendChild(cam2Label);
                
                if (pair.cam2) {
                    const img2 = document.createElement('img');
                    const baseUrl = pair.cam2.small_thumbnail_url || pair.cam2.thumbnail_url || pair.cam2.path;
                    const separator = baseUrl.includes('?') ? '&' : '?';
                    
                    // Log the image URL for debugging
                    console.log(`Camera 2 image URL: ${API_BASE_URL}${baseUrl}${separator}t=${new Date().getTime()}`);
                    logMessage(`Loading Camera 2 image: ${pair.cam2.filename}`);
                    
                    img2.src = `${API_BASE_URL}${baseUrl}${separator}t=${new Date().getTime()}`;
                    img2.alt = 'Vehicle from Camera 2';
                    img2.className = 'matched-vehicle-img cursor-pointer';
                    img2.title = `${pair.cam2.filename}\n${new Date(pair.cam2.timestamp).toLocaleTimeString()}`;
                    
                    // Add error handler for image loading
                    img2.onerror = (e) => {
                        console.error(`Failed to load image: ${img2.src}`, e);
                        logMessage(`Failed to load Camera 2 image: ${pair.cam2.filename}`);
                        // Replace with placeholder
                        img2.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f0f0f0'/%3E%3Ctext x='50' y='50' font-family='Arial' font-size='12' text-anchor='middle' dominant-baseline='middle' fill='%23999'%3EImage Error%3C/text%3E%3C/svg%3E";
                    };
                    
                    // Add load handler
                    img2.onload = () => {
                        logMessage(`Camera 2 image loaded: ${pair.cam2.filename}`);
                    };
                    
                    img2.addEventListener('click', () => {
                        showFullSizeImage(pair.cam2.path, pair.cam2.filename);
                    });
                    
                    cam2Container.appendChild(img2);
                    
                    // Show timestamp if available
                    if (pair.cam2.timestamp) {
                        const time = document.createElement('div');
                        time.className = 'text-xs text-gray-500 mt-1';
                        time.textContent = new Date(pair.cam2.timestamp).toLocaleTimeString();
                        cam2Container.appendChild(time);
                    }
                } else {
                    // Placeholder if no image for camera 2
                    const placeholder = document.createElement('div');
                    placeholder.className = 'matched-vehicle-img flex items-center justify-center bg-gray-200 text-gray-400 text-xs';
                    placeholder.textContent = 'No match';
                    cam2Container.appendChild(placeholder);
                }
                
                // Add all elements to the container
                imagesContainer.appendChild(cam1Container);
                imagesContainer.appendChild(arrowContainer);
                imagesContainer.appendChild(cam2Container);
                pairContainer.appendChild(imagesContainer);
                
                return pairContainer;
            }

            // Function to show full-size image in modal
            function showFullSizeImage(imagePath, filename) {
                // Create modal if it doesn't exist
                let modal = document.getElementById('imageModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'imageModal';
                    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden';
                    modal.innerHTML = `
                        <div class="relative max-w-4xl max-h-4xl p-4">
                            <button id="closeModal" class="absolute top-2 right-2 text-white text-2xl font-bold z-10 bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-75">
                                ×
                            </button>
                            <img id="modalImage" class="max-w-full max-h-full object-contain rounded" src="" alt="">
                            <div id="modalTitle" class="text-white text-center mt-2 font-medium"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // Add close handlers
                    document.getElementById('closeModal').addEventListener('click', () => {
                        modal.classList.add('hidden');
                    });
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.add('hidden');
                        }
                    });
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            modal.classList.add('hidden');
                        }
                    });
                }
                
                // Set image and show modal
                const modalImage = document.getElementById('modalImage');
                const modalTitle = document.getElementById('modalTitle');
                const separator = imagePath.includes('?') ? '&' : '?';
                modalImage.src = `${API_BASE_URL}${imagePath}${separator}t=${new Date().getTime()}`;
                modalTitle.textContent = filename;
                modal.classList.remove('hidden');
            }

            async function startSession() {
                try {
                    updateStatus('Initializing session...');
                    const response = await fetch(`${API_BASE_URL}/start_session`, { method: 'POST' });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    
                    sessionId = data.session_id;
                    sessionIdEl.textContent = sessionId;
                    logMessage(`Session started: ${sessionId}`);
                    
                    connectWebSocket();
                    updateButtons();
                    
                    // Fetch matches immediately to show test images
                    fetchLatestMatches();
                    
                    // Start polling for matches every 5 seconds
                    setInterval(fetchLatestMatches, 5000); // Poll every 5 seconds
                } catch (error) {
                    console.error('Failed to start session:', error);
                    updateStatus('Failed to start session. Please refresh.', 'error');
                    showNotification('Error starting session.', 'error');
                }
            }

            async function uploadFile(camera, file) {
                if (!sessionId) {
                    showNotification('Session not ready.', 'error');
                    return;
                }
                const uploadStatusEl = document.getElementById(`uploadStatus${camera === 'cam1' ? 1 : 2}`);
                uploadStatusEl.textContent = `Uploading ${file.name}...`;
                
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${API_BASE_URL}/upload_video/${sessionId}?camera=${camera}`, {
                        method: 'POST',
                        body: formData,
                    });
                    if (!response.ok) throw new Error(`Upload failed with status: ${response.status}`);
                    
                    const result = await response.json();
                    uploadStatusEl.innerHTML = `✅ ${file.name} uploaded.`;
                    logMessage(`Uploaded ${file.name} to ${camera}.`);
                    showNotification(`${file.name} uploaded successfully.`, 'success');
                    
                    uploads[camera] = true;
                    updateButtons();
                } catch (error) {
                    console.error(`Upload error for ${camera}:`, error);
                    uploadStatusEl.textContent = `❌ Upload failed. Please try again.`;
                    showNotification(`Error uploading ${file.name}.`, 'error');
                }
            }

            // --- EVENT HANDLERS ---
            startBtn.addEventListener('click', async () => {
                if (!sessionId) return;
                processing = true;
                updateStatus('Starting processing...', 'info');
                updateButtons();
                logMessage('Start processing command sent.');

                try {
                    const response = await fetch(`${API_BASE_URL}/start_processing/${sessionId}`, { method: 'POST' });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    updateStatus('Processing started.', 'success');
                    logMessage('Processing successfully started.');
                    showNotification('Processing started!', 'success');
                } catch (error) {
                    console.error('Failed to start processing:', error);
                    updateStatus('Error starting processing.', 'error');
                    showNotification('Failed to start processing.', 'error');
                    processing = false;
                    updateButtons();
                }
            });

            stopBtn.addEventListener('click', async () => {
                if (!sessionId) return;
                updateStatus('Stopping processing...', 'warning');
                logMessage('Stop processing command sent.');

                try {
                    const response = await fetch(`${API_BASE_URL}/stop_processing/${sessionId}`, { method: 'POST' });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    
                    updateStatus('Processing stopped. Ready for new session.', 'info');
                    logMessage('Processing stopped.');
                    showNotification('Processing stopped.', 'success');
                    
                    processing = false;
                    if (websocket) websocket.close();
                    
                    // Reset for a new session
                    setTimeout(() => window.location.reload(), 2000);

                } catch (error) {
                    console.error('Failed to stop processing:', error);
                    updateStatus('Error stopping processing.', 'error');
                    showNotification('Failed to stop processing.', 'error');
                }
            });

            // --- UPLOAD ZONE SETUP ---
            function setupUploadZone(zoneId, inputId, cameraName) {
                const zone = document.getElementById(zoneId);
                const input = document.getElementById(inputId);

                zone.addEventListener('click', () => input.click());
                
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });
                
                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('drag-over');
                });
                
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    
                    if (e.dataTransfer.files.length > 0) {
                        const file = e.dataTransfer.files[0];
                        if (file.type.startsWith('video/')) {
                            uploadFile(cameraName, file);
                        } else {
                            showNotification('Please upload a video file.', 'error');
                        }
                    }
                });
                
                input.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        if (file.type.startsWith('video/')) {
                            uploadFile(cameraName, file);
                        } else {
                            showNotification('Please upload a video file.', 'error');
                        }
                    }
                });
            }

            setupUploadZone('uploadZone1', 'videoFile1', 'cam1');
            setupUploadZone('uploadZone2', 'videoFile2', 'cam2');

            // --- INITIALIZATION ---
            startSession();
        });
    </script>
</body>
</html>
